<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Put It To The Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.292.0?external=react",
          "firebase/app": "https://esm.sh/firebase@10.7.1/app",
          "firebase/auth": "https://esm.sh/firebase@10.7.1/auth",
          "firebase/firestore": "https://esm.sh/firebase@10.7.1/firestore"
        }
      }
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      #error-container {
        display: none;
        padding: 20px;
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #f87171;
        margin: 20px;
        border-radius: 8px;
        font-family: monospace;
      }
    </style>
  </head>
  <body class="bg-slate-50">
    
    <div id="error-container">
      <strong>Application Error:</strong>
      <pre id="error-message"></pre>
      <p>Check the console (F12) for more details.</p>
    </div>

    <div id="root">
      <div class="text-center pt-20">
        <div class="loader"></div>
        <p class="text-slate-500">Loading Game Resources...</p>
      </div>
    </div>

    <script>
      window.onerror = function(msg, url, lineNo, columnNo, error) {
        document.getElementById('root').style.display = 'none';
        document.getElementById('error-container').style.display = 'block';
        document.getElementById('error-message').textContent = msg + '\nLine: ' + lineNo;
        return false;
      };

      // --- CONFIGURATION ---
      window.firebaseConfig = {}; 
      window.initialAuthToken = "";
      window.appId = "local-dev-app";
      // Point this to your deployed worker URL if you have one
      window.backendUrl = ""; 
    </script>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback } from 'react';
      import { createRoot } from 'react-dom/client';
      import { initializeApp } from 'firebase/app';
      import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
      import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from 'firebase/firestore';
      import { BookOpen, Trophy, Play, CheckCircle, XCircle, RotateCcw, RefreshCw, ArrowRight, Quote } from 'lucide-react';

      /**
       * ------------------------------------------------------------------
       * SECTION 1: DATA LAYER & INIT
       * ------------------------------------------------------------------
       */

      let app, auth, db;
      let isMockMode = false;

      try {
        const config = window.firebaseConfig || {};
        if (!config.apiKey) {
          isMockMode = true;
          console.log("No Firebase API Key found. Using Local Mock Mode.");
        } else {
          app = initializeApp(config);
          auth = getAuth(app);
          db = getFirestore(app);
        }
      } catch (error) {
        console.warn("Firebase init failed. Switching to Local Mock Mode.", error);
        isMockMode = true;
      }

      const appId = window.appId || 'default-app-id';

      // STATIC FALLBACK DATA
      const STATIC_DATA = [
        { id: 1, term: "put off", type: "verb", definition: "To delay an event or activity until a later time.", examples: ["She shouldn't put off going to the dentist.", "We put off the meeting because everyone is on leave."] },
        { id: 2, term: "put off by", type: "verb", definition: "To make someone dislike something or to discourage them.", examples: ["The sight of blood puts me off donating.", "I was put off by his messy appearance."] },
        { id: 3, term: "put someone off", type: "verb", definition: "To delay seeing someone or stop them until later.", examples: ["I'd rather put them off than meet today.", "I had to put Trang off due to a meeting."] },
        { id: 4, term: "put up with", type: "verb", definition: "To tolerate someone or something unpleasant.", examples: ["I can't put up with the karaoke noise.", "It's cold, but I'll put up with it."] },
        { id: 5, term: "put an end to", type: "phrase", definition: "To make something stop happening or existing.", examples: ["How can we put an end to the conflict?", "The team put an end to their losing streak."] },
        { id: 6, term: "put your feet up", type: "idiom", definition: "To relax, chill, literally resting feet on something.", examples: ["I'm putting my feet up this weekend.", "Everyone is away, so I'll put my feet up."] },
        { id: 7, term: "put in a good word", type: "phrase", definition: "To say positive things about someone (often for a job).", examples: ["I can put in a good word for you with HR.", "She put in a good word for me with the boss."] },
        { id: 8, term: "put heads together", type: "idiom", definition: "When two or more people plan or solve something together.", examples: ["We'll figure it out if we put our heads together.", "They solved it after putting their heads together."] },
        { id: 9, term: "put two and two together", type: "idiom", definition: "To guess the truth from what you see or hear.", examples: ["I saw them holding hands and put two and two together."] },
        { id: 10, term: "put down (object)", type: "verb", definition: "To place something on a surface or stop carrying someone.", examples: ["I put my bags down.", "Put me down, Daddy!"] },
        { id: 11, term: "put down (person)", type: "verb", definition: "To criticize someone to make them feel silly or unimportant.", examples: ["Why did you put me down in front of the class?", "The teacher put me down for not knowing the alphabet."] },
      ];

      // [NEW] Reading Passages
      const READING_PASSAGES = [
        {
          title: "The Office Party",
          content: "I wanted to **put off** the office party because I was so busy, but my boss wouldn't **put up with** any delays. We all **put our heads together** to plan the menu. I decided to **put in a good word** for the new catering company my friend started."
        },
        {
          title: "A Quiet Weekend",
          content: "After a long week, I just want to go home and **put my feet up**. The construction noise next door was hard to **put up with**, but I finally went over and asked them to **put an end to** the racket. They were nice about it."
        },
        {
          title: "The Misunderstanding",
          content: "When I saw them whispering, I **put two and two together** and assumed they were dating. But I was wrong! He was just helping her **put down** some heavy boxes. I felt bad for assuming, I hope I didn't **put them down** by making a silly joke about it."
        }
      ];

      const getRandomItems = (arr, n) => {
        const shuffled = [...arr].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, n);
      };

      /**
       * ------------------------------------------------------------------
       * SECTION 2: DESIGN SYSTEM
       * ------------------------------------------------------------------
       */

      const Card = ({ children, className = "" }) => (
        <div className={`bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden ${className}`}>
          {children}
        </div>
      );

      const Button = ({ onClick, variant = "primary", className = "", children, disabled = false }) => {
        const variants = {
          primary: "bg-indigo-600 hover:bg-indigo-700 text-white shadow-md hover:shadow-lg",
          secondary: "bg-white hover:bg-slate-50 text-slate-700 border border-slate-200",
          danger: "bg-red-500 hover:bg-red-600 text-white",
          success: "bg-emerald-500 hover:bg-emerald-600 text-white",
          outline: "border-2 border-indigo-600 text-indigo-600 hover:bg-indigo-50",
          ghost: "text-slate-500 hover:bg-slate-100 hover:text-indigo-600"
        };
        return (
          <button 
            onClick={onClick}
            disabled={disabled}
            className={`px-6 py-3 rounded-lg font-semibold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:pointer-events-none flex items-center justify-center gap-2 ${variants[variant]} ${className}`}
          >
            {children}
          </button>
        );
      };

      // [UPDATED] FeedbackOverlay now has Next Button and shows multiple examples
      const FeedbackOverlay = ({ type, msg, examples, onNext }) => (
        <div className={`p-6 ${type === 'correct' ? 'bg-emerald-50 border-t-4 border-emerald-500' : 'bg-red-50 border-t-4 border-red-500'} animate-in slide-in-from-bottom-2`}>
          <div className="flex items-center gap-3 mb-4">
            {type === 'correct' ? <CheckCircle className="w-6 h-6 text-emerald-600" /> : <XCircle className="w-6 h-6 text-red-600" />}
            <span className={`font-bold text-lg ${type === 'correct' ? 'text-emerald-800' : 'text-red-800'}`}>{msg}</span>
          </div>
          
          {examples && examples.length > 0 && (
            <div className="space-y-3 mb-6">
              <h4 className="text-xs font-bold uppercase tracking-wider text-slate-500">Examples in Context:</h4>
              {examples.map((ex, i) => (
                <div key={i} className="flex gap-2 text-sm text-slate-700 italic bg-white/60 p-2 rounded border border-black/5">
                  <span className="text-indigo-400 font-serif">"</span>
                  {ex}
                  <span className="text-indigo-400 font-serif">"</span>
                </div>
              ))}
            </div>
          )}

          <div className="flex justify-end">
             <Button onClick={onNext} variant={type === 'correct' ? 'success' : 'primary'}>
               Next Question <ArrowRight className="w-4 h-4" />
             </Button>
          </div>
        </div>
      );

      const ProgressBar = ({ current, total }) => (
        <div className="w-full bg-slate-200 h-2 rounded-full mb-8 overflow-hidden">
          <div 
            className="bg-indigo-600 h-full transition-all duration-500 ease-out" 
            style={{ width: `${(current / total) * 100}%` }}
          />
        </div>
      );

      /**
       * ------------------------------------------------------------------
       * SECTION 3: LOGIC KERNEL (HOOKS)
       * ------------------------------------------------------------------
       */

      const useAuth = () => {
        const [user, setUser] = useState(null);
        useEffect(() => {
          if (isMockMode) {
            setUser({ uid: 'mock-user-12345', isAnonymous: true });
            return;
          }
          const initAuth = async () => {
            if (window.initialAuthToken) await signInWithCustomToken(auth, window.initialAuthToken);
            else await signInAnonymously(auth);
          };
          initAuth();
          return onAuthStateChanged(auth, setUser);
        }, []);
        return user;
      };

      const useLeaderboard = (user) => {
        const [data, setData] = useState([]);
        useEffect(() => {
          if (!user) return;
          if (isMockMode) {
            const stored = localStorage.getItem('mockLeaderboard');
            const mockData = stored ? JSON.parse(stored) : [];
            setData(mockData.sort((a, b) => b.score - a.score).slice(0, 10));
            return;
          }
          const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
          return onSnapshot(colRef, (snapshot) => {
            const rawData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setData(rawData.sort((a, b) => b.score - a.score).slice(0, 10));
          }, console.error);
        }, [user]);

        const saveScore = async (score) => {
          if (user && score > 0) {
            if (isMockMode) {
              const stored = localStorage.getItem('mockLeaderboard');
              const currentData = stored ? JSON.parse(stored) : [];
              currentData.push({ name: `Learner ${user.uid.substr(0, 4)}`, score, timestamp: Date.now() });
              localStorage.setItem('mockLeaderboard', JSON.stringify(currentData));
              setData(currentData.sort((a, b) => b.score - a.score).slice(0, 10));
              return;
            }
            try {
              await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), {
                name: `Learner ${user.uid.substr(0, 4)}`,
                score: score,
                timestamp: serverTimestamp()
              });
            } catch (e) { console.error("Error saving score:", e); }
          }
        };
        return { data, saveScore };
      };

      const useGameEngine = (onGameEnd, gameData) => {
        const [questions, setQuestions] = useState([]);
        const [currentIndex, setCurrentIndex] = useState(0);
        const [score, setScore] = useState(0);
        const [streak, setStreak] = useState(0);
        const [feedback, setFeedback] = useState(null);
        const [isPlaying, setIsPlaying] = useState(false);

        const generateQuestions = useCallback(() => {
          const newQuestions = [];
          const sourceData = getRandomItems(gameData, 10);
          sourceData.forEach(item => {
            const isGapFill = Math.random() > 0.5;
            const distractors = getRandomItems(gameData.filter(pv => pv.id !== item.id), 3).map(pv => pv.term);

            if (isGapFill && item.examples.length > 0) {
              const example = item.examples[0];
              const regex = new RegExp(item.term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
              if (regex.test(example)) {
                 newQuestions.push({
                  type: 'gap-fill',
                  question: example.replace(regex, '_______'),
                  correct: item.term,
                  options: getRandomItems([...distractors, item.term], 4),
                  explanation: item.definition
                });
              } else {
                newQuestions.push({
                  type: 'definition',
                  question: `What is the meaning of "${item.term}"?`,
                  correct: item.definition,
                  options: getRandomItems([...distractors.map(d => {
                     const original = gameData.find(p => p.term === d);
                     return original ? original.definition : "To do something.";
                  }), item.definition], 4),
                  explanation: `Correct! "${item.term}" means: ${item.definition}`
                });
              }
            } else {
              newQuestions.push({
                type: 'definition',
                question: `Which phrase means: "${item.definition}"?`,
                correct: item.term,
                options: getRandomItems([...distractors, item.term], 4),
                explanation: item.examples[0] || item.definition
              });
            }
          });
          return newQuestions;
        }, [gameData]);

        const startGame = () => {
          setQuestions(generateQuestions());
          setScore(0);
          setStreak(0);
          setCurrentIndex(0);
          setFeedback(null);
          setIsPlaying(true);
        };

        const submitAnswer = (selected) => {
          const currentQ = questions[currentIndex];
          const isCorrect = selected === currentQ.correct;
          
          const correctItem = gameData.find(p => p.term === currentQ.correct);
          // [UPDATED] Get up to 2 examples for the feedback
          const examples = correctItem?.examples.slice(0, 2) || ["No example available."];

          if (isCorrect) {
            const streakBonus = Math.min(streak * 10, 50);
            setScore(s => s + 100 + streakBonus);
            setStreak(s => s + 1);
            setFeedback({ 
              type: 'correct', 
              msg: 'Spot on! ' + (streak > 1 ? `Streak x${streak}!` : ''), 
              selected,
              examples
            });
          } else {
            setStreak(0);
            setFeedback({ 
              type: 'incorrect', 
              msg: `Not quite. The correct answer was: "${currentQ.correct}"`, 
              selected,
              examples
            });
          }
          
          // [UPDATED] Removed setTimeout. Game waits for user to click next.
        };

        const nextQuestion = () => {
          setFeedback(null);
          if (currentIndex < questions.length - 1) {
            setCurrentIndex(c => c + 1);
          } else {
            setIsPlaying(false);
            onGameEnd(score); // Pass current score
          }
        };

        return { questions, currentIndex, score, feedback, isPlaying, startGame, submitAnswer, nextQuestion };
      };

      /**
       * ------------------------------------------------------------------
       * SECTION 4: VIEW LAYER (APP COMPONENT)
       * ------------------------------------------------------------------
       */

      function App() {
        const [view, setView] = useState('start');
        const [gameData, setGameData] = useState(STATIC_DATA);
        const [isFetching, setIsFetching] = useState(false);
        const user = useAuth();
        const { data: leaderboardData, saveScore } = useLeaderboard(user);
        
        // Fetch dynamic content on mount
        useEffect(() => {
          const fetchDailyContent = async () => {
            if (!window.backendUrl) return; 
            try {
              setIsFetching(true);
              const res = await fetch(window.backendUrl);
              if (res.ok) {
                const dailyData = await res.json();
                if (Array.isArray(dailyData) && dailyData.length > 0) {
                  setGameData(dailyData);
                  console.log("Loaded fresh daily content!");
                }
              }
            } catch (e) {
              console.warn("Using static fallback data:", e);
            } finally {
              setIsFetching(false);
            }
          };
          fetchDailyContent();
        }, []);

        const { 
          questions, currentIndex, score, feedback, isPlaying, 
          startGame: engineStart, submitAnswer, nextQuestion
        } = useGameEngine((finalScore) => {
          saveScore(finalScore);
          setView('result');
        }, gameData);

        const handleStartGame = () => {
          engineStart();
          setView('game');
        };

        // --- SUB-VIEWS ---
        const StartView = () => (
          <div className="text-center space-y-8 py-12 px-6 max-w-4xl mx-auto">
            <div className="space-y-4">
              <div className="inline-block p-4 bg-indigo-100 rounded-full mb-4">
                <BookOpen className="w-12 h-12 text-indigo-600" />
              </div>
              <h1 className="text-4xl font-extrabold text-slate-900 tracking-tight">Put It To The Test</h1>
              <p className="text-lg text-slate-600 max-w-md mx-auto">
                Master the tricky uses of "put" in English. 10 questions, speed bonuses, and global leaderboards.
              </p>
              
              <div className="flex justify-center gap-2 text-xs font-semibold">
                {isFetching ? (
                  <span className="text-slate-400 flex items-center gap-1"><RefreshCw className="w-3 h-3 animate-spin"/> Checking for updates...</span>
                ) : gameData === STATIC_DATA ? (
                  <span className="text-slate-400">Using Offline Data</span>
                ) : (
                  <span className="text-emerald-600 flex items-center gap-1"><RefreshCw className="w-3 h-3"/> Daily Context Loaded</span>
                )}
              </div>

              {isMockMode && (
                <p className="text-xs text-amber-600 bg-amber-50 inline-block px-3 py-1 rounded-full border border-amber-200">
                  Running in Local Mode (No Backend)
                </p>
              )}
            </div>

            <div className="flex flex-col sm:flex-row gap-4 justify-center mb-12">
              <Button onClick={handleStartGame} className="w-full sm:w-auto"><Play className="w-5 h-5" /> Start Quiz</Button>
              <Button variant="secondary" onClick={() => setView('learn')} className="w-full sm:w-auto"><BookOpen className="w-5 h-5" /> Study Sheet</Button>
              <Button variant="secondary" onClick={() => setView('leaderboard')} className="w-full sm:w-auto"><Trophy className="w-5 h-5" /> Leaderboard</Button>
            </div>

            {/* [NEW] Reading Passages Section */}
            <div className="text-left bg-white rounded-2xl shadow-sm border border-slate-100 p-8">
              <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                <Quote className="w-5 h-5 text-indigo-500" /> Mini-Stories: See them in action
              </h3>
              <div className="grid md:grid-cols-3 gap-6">
                {READING_PASSAGES.map((passage, idx) => (
                  <div key={idx} className="bg-slate-50 p-5 rounded-lg border border-slate-200 hover:border-indigo-300 transition-colors">
                    <h4 className="font-bold text-indigo-900 mb-2 text-sm uppercase tracking-wide">{passage.title}</h4>
                    <p className="text-slate-600 text-sm leading-relaxed whitespace-pre-line">
                      {/* React way to render bold markdown roughly */}
                      {passage.content.split('**').map((part, i) => 
                        i % 2 === 1 ? <span key={i} className="font-bold text-indigo-600 bg-indigo-50 px-1 rounded">{part}</span> : part
                      )}
                    </p>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );

        const GameView = () => {
          if (!questions.length) return <div>Loading...</div>;
          const q = questions[currentIndex];
          return (
            <div className="max-w-2xl mx-auto p-4 w-full">
              <div className="flex justify-between items-center mb-6 text-sm font-semibold text-slate-500 uppercase tracking-wider">
                <span>Question {currentIndex + 1}/{questions.length}</span>
                <span>Score: {score}</span>
              </div>
              <ProgressBar current={currentIndex} total={questions.length} />
              <Card className="mb-6">
                {!feedback && (
                  <div className="p-8">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6 leading-relaxed">{q.question}</h2>
                    <div className="grid gap-3">
                      {q.options.map((opt, idx) => (
                        <button
                          key={idx}
                          onClick={() => submitAnswer(opt)}
                          className="w-full text-left p-4 rounded-lg border-2 font-medium transition-all border-slate-200 hover:border-indigo-400 hover:bg-indigo-50 text-slate-700"
                        >
                          {opt}
                        </button>
                      ))}
                    </div>
                  </div>
                )}
                
                {feedback && (
                  <FeedbackOverlay 
                    type={feedback.type} 
                    msg={feedback.msg} 
                    examples={feedback.examples}
                    onNext={nextQuestion}
                  />
                )}
              </Card>
            </div>
          );
        };

        const ResultView = () => (
          <div className="text-center py-12 px-6">
            <div className="inline-block p-4 bg-yellow-100 rounded-full mb-6 animate-bounce">
              <Trophy className="w-16 h-16 text-yellow-600" />
            </div>
            <h2 className="text-3xl font-bold text-slate-900 mb-2">Quiz Complete!</h2>
            <div className="text-6xl font-black text-indigo-600 mb-12 tracking-tighter">
              {score} <span className="text-xl text-slate-400 font-normal">pts</span>
            </div>
            <div className="flex justify-center gap-4">
              <Button onClick={handleStartGame}><RotateCcw className="w-5 h-5" /> Play Again</Button>
              <Button variant="outline" onClick={() => setView('start')}>Back to Home</Button>
            </div>
          </div>
        );

        const LeaderboardView = () => (
          <div className="max-w-md mx-auto p-4 w-full">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                <Trophy className="w-6 h-6 text-yellow-500" /> Leaderboard
              </h2>
              <button onClick={() => setView('start')} className="text-slate-400 hover:text-slate-600">Close</button>
            </div>
            <Card className="divide-y divide-slate-100">
              {leaderboardData.length === 0 ? (
                <div className="p-8 text-center text-slate-500">No scores yet.</div>
              ) : (
                leaderboardData.map((entry, idx) => (
                  <div key={idx} className="flex items-center justify-between p-4 hover:bg-slate-50">
                    <div className="flex items-center gap-4">
                      <span className={`w-8 h-8 flex items-center justify-center rounded-full font-bold ${idx < 3 ? 'bg-yellow-100 text-yellow-700' : 'bg-slate-100'}`}>{idx + 1}</span>
                      <span className="font-medium text-slate-800">{entry.name}</span>
                    </div>
                    <span className="font-bold text-indigo-600">{entry.score}</span>
                  </div>
                ))
              )}
            </Card>
            <div className="mt-6 text-center"><Button variant="outline" onClick={() => setView('start')}>Back</Button></div>
          </div>
        );

        const LearnView = () => (
          <div className="max-w-2xl mx-auto p-4 h-full w-full">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-slate-900">Cheat Sheet</h2>
              <Button variant="outline" onClick={() => setView('start')}>Close</Button>
            </div>
            <div className="grid gap-4 pb-12">
              {gameData.map(item => (
                <Card key={item.id} className="p-5 border-l-4 border-l-indigo-500">
                  <div className="flex justify-between items-start">
                    <div>
                      <h3 className="text-lg font-bold text-indigo-900 mb-1">{item.term}</h3>
                      <p className="text-slate-600 italic mb-3 text-sm">{item.definition}</p>
                    </div>
                  </div>
                  <div className="bg-slate-50 p-3 rounded text-sm text-slate-700">"{item.examples[0]}"</div>
                </Card>
              ))}
            </div>
          </div>
        );

        return (
          <div className="min-h-screen bg-slate-50 font-sans text-slate-900 flex flex-col items-center justify-center">
            {view === 'start' && <StartView />}
            {view === 'game' && <GameView />}
            {view === 'result' && <ResultView />}
            {view === 'leaderboard' && <LeaderboardView />}
            {view === 'learn' && <LearnView />}
            <div className="fixed bottom-4 text-slate-400 text-xs">MVP v1.2 â€¢ Stories & Manual Next</div>
          </div>
        );
      }

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
