<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Put It To The Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.292.0?external=react",
          "firebase/app": "https://esm.sh/firebase@10.7.1/app",
          "firebase/auth": "https://esm.sh/firebase@10.7.1/auth",
          "firebase/firestore": "https://esm.sh/firebase@10.7.1/firestore"
        }
      }
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
      }
      .loader {
        border: 3px solid #e2e8f0;
        border-top: 3px solid #6366f1;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      .fade-in { animation: fadeIn 0.3s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen text-slate-800">
    
    <div id="root"></div>

    <script>
      window.firebaseConfig = {}; 
      window.initialAuthToken = "";
      window.appId = "local-dev-app";
      // [FIX] Added the backend URL from your screenshot
      window.backendUrl = "https://the-uses-of-put.mchoules1993.workers.dev"; 
    </script>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import { initializeApp } from 'firebase/app';
      import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
      import { 
        getFirestore, collection, addDoc, onSnapshot, serverTimestamp, 
        doc, setDoc, increment, getDoc 
      } from 'firebase/firestore';
      import { 
        BookOpen, Trophy, Play, CheckCircle, XCircle, RotateCcw, 
        RefreshCw, ArrowRight, ArrowLeft, Quote, Sparkles, Home,
        BarChart3, User, AlertCircle
      } from 'lucide-react';

      /**
       * ------------------------------------------------------------------
       * SECTION 1: DATA LAYER & INIT
       * ------------------------------------------------------------------
       */

      let app, auth, db;
      let isMockMode = false;

      try {
        const config = window.firebaseConfig || {};
        if (!config.apiKey) {
          isMockMode = true;
          console.log("No Firebase API Key found. Using Local Mock Mode.");
        } else {
          app = initializeApp(config);
          auth = getAuth(app);
          db = getFirestore(app);
        }
      } catch (error) {
        console.warn("Firebase init failed. Switching to Local Mock Mode.", error);
        isMockMode = true;
      }

      const appId = window.appId || 'default-app-id';

      // STATIC FALLBACK DATA
      const STATIC_DATA = [
        { id: 1, term: "put off", type: "verb", definition: "To delay an event or activity until a later time.", examples: ["She shouldn't put off going to the dentist.", "We put off the meeting because everyone is on leave."] },
        { id: 2, term: "put off by", type: "verb", definition: "To make someone dislike something or to discourage them.", examples: ["The sight of blood puts me off donating.", "I was put off by his messy appearance."] },
        { id: 3, term: "put someone off", type: "verb", definition: "To delay seeing someone or stop them until later.", examples: ["I'd rather put them off than meet today.", "I had to put Trang off due to a meeting."] },
        { id: 4, term: "put up with", type: "verb", definition: "To tolerate someone or something unpleasant.", examples: ["I can't put up with the karaoke noise.", "It's cold, but I'll put up with it."] },
        { id: 5, term: "put an end to", type: "phrase", definition: "To make something stop happening or existing.", examples: ["How can we put an end to the conflict?", "The team put an end to their losing streak."] },
        { id: 6, term: "put your feet up", type: "idiom", definition: "To relax, chill, literally resting feet on something.", examples: ["I'm putting my feet up this weekend.", "Everyone is away, so I'll put my feet up."] },
        { id: 7, term: "put in a good word", type: "phrase", definition: "To say positive things about someone (often for a job).", examples: ["I can put in a good word for you with HR.", "She put in a good word for me with the boss."] },
        { id: 8, term: "put heads together", type: "idiom", definition: "When two or more people plan or solve something together.", examples: ["We'll figure it out if we put our heads together.", "They solved it after putting their heads together."] },
        { id: 9, term: "put two and two together", type: "idiom", definition: "To guess the truth from what you see or hear.", examples: ["I saw them holding hands and put two and two together."] },
        { id: 10, term: "put down (object)", type: "verb", definition: "To place something on a surface or stop carrying someone.", examples: ["I put my bags down.", "Put me down, Daddy!"] },
        { id: 11, term: "put down (person)", type: "verb", definition: "To criticize someone to make them feel silly or unimportant.", examples: ["Why did you put me down in front of the class?", "The teacher put me down for not knowing the alphabet."] },
      ];

      const READING_PASSAGES = [
        {
          title: "The Office Party",
          content: "I wanted to **put off** the office party because I was so busy, but my boss wouldn't **put up with** any delays. We all **put our heads together** to plan the menu. I decided to **put in a good word** for the new catering company my friend started."
        },
        {
          title: "A Quiet Weekend",
          content: "After a long week, I just want to go home and **put my feet up**. The construction noise next door was hard to **put up with**, but I finally went over and asked them to **put an end to** the racket. They were nice about it."
        },
        {
          title: "The Misunderstanding",
          content: "When I saw them whispering, I **put two and two together** and assumed they were dating. But I was wrong! He was just helping her **put down** some heavy boxes. I felt bad for assuming, I hope I didn't **put them down** by making a silly joke about it."
        }
      ];

      const getRandomItems = (arr, n) => {
        const shuffled = [...arr].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, n);
      };

      /**
       * ------------------------------------------------------------------
       * SECTION 2: DESIGN SYSTEM
       * ------------------------------------------------------------------
       */

      const Layout = ({ children, onHome, title }) => (
        <div className="min-h-screen flex flex-col items-center justify-center p-4">
          <div className="w-full max-w-4xl relative">
            {/* Header / Nav */}
            <div className="absolute top-0 right-0 z-10">
              <button 
                onClick={onHome}
                className="bg-white/80 backdrop-blur p-3 rounded-full shadow-sm hover:shadow-md text-slate-500 hover:text-indigo-600 transition-all border border-slate-200"
                title="Go Home"
              >
                <Home className="w-5 h-5" />
              </button>
            </div>
            
            <div className="fade-in">
              {children}
            </div>
          </div>
          <div className="fixed bottom-4 text-slate-400 text-xs font-medium">
            Put It To The Test â€¢ v2.0
          </div>
        </div>
      );

      const Card = ({ children, className = "" }) => (
        <div className={`bg-white rounded-2xl shadow-sm border border-slate-200/60 overflow-hidden ${className}`}>
          {children}
        </div>
      );

      const Button = ({ onClick, variant = "primary", className = "", children, disabled = false }) => {
        const variants = {
          primary: "bg-indigo-600 hover:bg-indigo-700 text-white shadow hover:shadow-md",
          secondary: "bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 shadow-sm",
          danger: "bg-rose-500 hover:bg-rose-600 text-white shadow",
          success: "bg-emerald-500 hover:bg-emerald-600 text-white shadow",
          outline: "border-2 border-indigo-600 text-indigo-600 hover:bg-indigo-50",
          ghost: "text-slate-500 hover:bg-slate-100 hover:text-indigo-600"
        };
        return (
          <button 
            onClick={onClick}
            disabled={disabled}
            className={`px-6 py-3 rounded-xl font-semibold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:pointer-events-none flex items-center justify-center gap-2 ${variants[variant]} ${className}`}
          >
            {children}
          </button>
        );
      };

      const FeedbackOverlay = ({ type, msg, examples, onNext, onPrev, isFirst }) => (
        <div className={`p-6 rounded-xl border-l-4 ${type === 'correct' ? 'bg-emerald-50 border-emerald-500' : 'bg-rose-50 border-rose-500'} animate-in slide-in-from-bottom-2 mt-4`}>
          <div className="flex items-center gap-3 mb-4">
            {type === 'correct' ? <CheckCircle className="w-6 h-6 text-emerald-600" /> : <XCircle className="w-6 h-6 text-rose-600" />}
            <span className={`font-bold text-lg ${type === 'correct' ? 'text-emerald-900' : 'text-rose-900'}`}>{msg}</span>
          </div>
          
          {examples && examples.length > 0 && (
            <div className="space-y-3 mb-6 bg-white/60 p-4 rounded-lg border border-black/5">
              <h4 className="text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Examples in Context:</h4>
              {examples.map((ex, i) => (
                <div key={i} className="flex gap-2 text-sm text-slate-700 italic">
                  <span className="text-indigo-400 font-serif font-bold">"</span>
                  <span className="leading-relaxed">{ex}</span>
                </div>
              ))}
            </div>
          )}

          <div className="flex justify-between items-center pt-2">
             <Button onClick={onPrev} variant="ghost" disabled={isFirst} className="text-sm px-3 h-10">
               <ArrowLeft className="w-4 h-4" /> Prev
             </Button>
             <Button onClick={onNext} variant={type === 'correct' ? 'success' : 'primary'} className="h-10">
               Next <ArrowRight className="w-4 h-4" />
             </Button>
          </div>
        </div>
      );

      const ProgressBar = ({ current, total }) => (
        <div className="w-full bg-slate-200 h-2 rounded-full mb-8 overflow-hidden">
          <div 
            className="bg-indigo-600 h-full transition-all duration-500 ease-out" 
            style={{ width: `${((current + 1) / total) * 100}%` }}
          />
        </div>
      );

      /**
       * ------------------------------------------------------------------
       * SECTION 3: LOGIC KERNEL (HOOKS)
       * ------------------------------------------------------------------
       */

      // Stats Recorder Helper
      const recordQuestionStat = async (term, isCorrect) => {
        if (isMockMode) return; 
        try {
          const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'stats', term);
          await setDoc(statsRef, {
            term: term, 
            attempts: increment(1),
            incorrect: increment(isCorrect ? 0 : 1)
          }, { merge: true });
        } catch (e) {
          console.error("Failed to record stats", e);
        }
      };

      const useAuth = () => {
        const [user, setUser] = useState(null);
        useEffect(() => {
          if (isMockMode) {
            setUser({ uid: 'mock-user-12345', isAnonymous: true });
            return;
          }
          const initAuth = async () => {
            if (window.initialAuthToken) await signInWithCustomToken(auth, window.initialAuthToken);
            else await signInAnonymously(auth);
          };
          initAuth();
          return onAuthStateChanged(auth, setUser);
        }, []);
        return user;
      };

      const useDataServices = (user) => {
        const [leaderboard, setLeaderboard] = useState([]);
        const [globalStats, setGlobalStats] = useState([]);

        // Fetch Leaderboard
        useEffect(() => {
          if (!user || isMockMode) return;
          const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
          return onSnapshot(colRef, (snapshot) => {
            const rawData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setLeaderboard(rawData.sort((a, b) => b.score - a.score).slice(0, 10));
          }, console.error);
        }, [user]);

        // Fetch Global Stats
        useEffect(() => {
          if (!user || isMockMode) return;
          const statsRef = collection(db, 'artifacts', appId, 'public', 'data', 'stats');
          return onSnapshot(statsRef, (snapshot) => {
            const rawData = snapshot.docs.map(doc => doc.data());
            const processed = rawData.map(item => ({
              ...item,
              failRate: item.attempts > 0 ? (item.incorrect / item.attempts) : 0
            })).sort((a, b) => b.failRate - a.failRate); 
            setGlobalStats(processed);
          });
        }, [user]);

        const saveScore = async (score, playerName) => {
          if (user && score > 0) {
            if (isMockMode) {
              console.log("Mock Save Score:", score, playerName);
              return;
            }
            try {
              await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), {
                name: playerName || `Learner ${user.uid.substr(0, 4)}`,
                score: score,
                timestamp: serverTimestamp()
              });
            } catch (e) { console.error("Error saving score:", e); }
          }
        };

        return { leaderboard, globalStats, saveScore };
      };

      const useGameEngine = (onGameEnd, gameData) => {
        const [questions, setQuestions] = useState([]);
        const [currentIndex, setCurrentIndex] = useState(0);
        const [score, setScore] = useState(0);
        const [streak, setStreak] = useState(0);
        const [history, setHistory] = useState({});
        const [isPlaying, setIsPlaying] = useState(false);

        const generateQuestions = useCallback(() => {
          const newQuestions = [];
          const sourceData = getRandomItems(gameData, 10);
          sourceData.forEach(item => {
            const isGapFill = Math.random() > 0.5;
            const distractors = getRandomItems(gameData.filter(pv => pv.id !== item.id), 3).map(pv => pv.term);

            if (isGapFill && item.examples.length > 0) {
              const example = item.examples[0];
              const regex = new RegExp(item.term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
              if (regex.test(example)) {
                 newQuestions.push({
                  type: 'gap-fill',
                  question: example.replace(regex, '_______'),
                  correct: item.term,
                  options: getRandomItems([...distractors, item.term], 4),
                  explanation: item.definition,
                  originalExample: example
                });
              } else {
                newQuestions.push({
                  type: 'definition',
                  question: `What is the meaning of "${item.term}"?`,
                  correct: item.definition,
                  options: getRandomItems([...distractors.map(d => {
                     const original = gameData.find(p => p.term === d);
                     return original ? original.definition : "To do something.";
                  }), item.definition], 4),
                  explanation: `Correct! "${item.term}" means: ${item.definition}`
                });
              }
            } else {
              newQuestions.push({
                type: 'definition',
                question: `Which phrase means: "${item.definition}"?`,
                correct: item.term,
                options: getRandomItems([...distractors, item.term], 4),
                explanation: item.examples[0] || item.definition
              });
            }
          });
          return newQuestions;
        }, [gameData]);

        const startGame = () => {
          setQuestions(generateQuestions());
          setScore(0);
          setStreak(0);
          setCurrentIndex(0);
          setHistory({});
          setIsPlaying(true);
        };

        const submitAnswer = (selected) => {
          if (history[currentIndex]) return;

          const currentQ = questions[currentIndex];
          const isCorrect = selected === currentQ.correct;
          
          recordQuestionStat(currentQ.correct, isCorrect);

          const correctItem = gameData.find(p => p.term === currentQ.correct);
          let allExamples = correctItem?.examples || [];

          if (currentQ.type === 'gap-fill' && currentQ.originalExample) {
             const others = allExamples.filter(e => e !== currentQ.originalExample);
             if (others.length > 0) allExamples = others;
          }
          const displayExamples = allExamples.slice(0, 2);

          let newScore = score;
          let newStreak = streak;

          if (isCorrect) {
            const streakBonus = Math.min(streak * 10, 50);
            newScore += 100 + streakBonus;
            newStreak += 1;
          } else {
            newStreak = 0;
          }

          setScore(newScore);
          setStreak(newStreak);

          const feedbackObj = { 
            type: isCorrect ? 'correct' : 'incorrect', 
            msg: isCorrect ? 'Spot on! ' + (newStreak > 1 ? `Streak x${newStreak}!` : '') : `Not quite. The correct answer was: "${currentQ.correct}"`, 
            selected,
            examples: displayExamples
          };

          setHistory(prev => ({
            ...prev,
            [currentIndex]: feedbackObj
          }));
        };

        const nextQuestion = () => {
          if (currentIndex < questions.length - 1) {
            setCurrentIndex(c => c + 1);
          } else {
            setIsPlaying(false);
            onGameEnd(score); 
          }
        };

        const prevQuestion = () => {
          if (currentIndex > 0) {
            setCurrentIndex(c => c - 1);
          }
        };

        return { 
          questions, currentIndex, score, feedback: history[currentIndex], 
          isPlaying, startGame, submitAnswer, nextQuestion, prevQuestion 
        };
      };

      /**
       * ------------------------------------------------------------------
       * SECTION 4: VIEW LAYER (COMPONENTS)
       * [FIX] Moved components OUTSIDE of App to prevent re-render focus loss
       * ------------------------------------------------------------------
       */

      const StartView = ({ playerName, setPlayerName, onStart, onSetView, isFetching, gameData, onRegenerate }) => (
        <div className="text-center space-y-8 py-8 px-6">
          <div className="space-y-2 mb-10">
            <div className="inline-flex p-3 bg-white rounded-2xl shadow-sm mb-4">
              <BookOpen className="w-10 h-10 text-indigo-600" />
            </div>
            <h1 className="text-5xl font-black text-slate-900 tracking-tight">Put It To The Test</h1>
            <p className="text-lg text-slate-500 font-medium">Master phrasal verbs. Challenge the world.</p>
          </div>

          <div className="bg-white p-8 rounded-3xl shadow-xl shadow-indigo-100/50 max-w-md mx-auto border border-slate-100">
            <div className="space-y-4">
              <div className="text-left">
                <label className="block text-xs font-bold uppercase tracking-wider text-slate-400 mb-1 ml-1">Player Name</label>
                <div className="relative">
                  <User className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                  <input 
                    type="text" 
                    value={playerName}
                    onChange={(e) => setPlayerName(e.target.value)}
                    placeholder="Enter your name..."
                    className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all font-medium text-slate-800"
                  />
                </div>
              </div>

              <Button onClick={onStart} className="w-full py-4 text-lg shadow-indigo-200 shadow-lg">
                <Play className="w-5 h-5 fill-current" /> Start Quiz
              </Button>
              
              <div className="grid grid-cols-2 gap-3 pt-2">
                <Button variant="secondary" onClick={() => onSetView('learn')} className="text-sm">
                  <BookOpen className="w-4 h-4" /> Cheat Sheet
                </Button>
                <Button variant="secondary" onClick={() => onSetView('leaderboard')} className="text-sm">
                  <Trophy className="w-4 h-4" /> Leaderboard
                </Button>
              </div>
            </div>
          </div>

          <div className="flex flex-wrap justify-center gap-4 mt-8">
            <Button onClick={() => onSetView('stats')} variant="ghost" className="bg-white border border-slate-200">
              <BarChart3 className="w-4 h-4" /> Global Hardest Questions
            </Button>
            <Button onClick={onRegenerate} variant="ghost" disabled={isFetching} className="bg-white border border-slate-200">
              {isFetching ? <RefreshCw className="w-4 h-4 animate-spin"/> : <Sparkles className="w-4 h-4" />}
              {isFetching ? "Generating..." : "Generate Fresh Questions"}
            </Button>
          </div>

          <div className="mt-12 text-left bg-white/80 backdrop-blur rounded-3xl p-8 border border-slate-200">
            <h3 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
              <Quote className="w-5 h-5 text-indigo-500" /> Mini-Stories
            </h3>
            <div className="grid md:grid-cols-3 gap-6">
              {READING_PASSAGES.map((passage, idx) => (
                <div key={idx} className="bg-slate-50 p-5 rounded-2xl border border-slate-200 hover:border-indigo-200 transition-colors">
                  <h4 className="font-bold text-indigo-900 mb-2 text-xs uppercase tracking-wide">{passage.title}</h4>
                  <p className="text-slate-600 text-sm leading-relaxed whitespace-pre-line">
                    {passage.content.split('**').map((part, i) => 
                      i % 2 === 1 ? <span key={i} className="font-bold text-indigo-600 bg-indigo-50 px-1 rounded">{part}</span> : part
                    )}
                  </p>
                </div>
              ))}
            </div>
          </div>
        </div>
      );

      const GameView = ({ questions, currentIndex, score, feedback, submitAnswer, prevQuestion, nextQuestion }) => {
        if (!questions.length) return <div className="text-center pt-20"><div className="loader mx-auto"></div></div>;
        const q = questions[currentIndex];
        return (
          <div className="max-w-2xl mx-auto w-full">
            <div className="flex justify-between items-center mb-6 px-2">
              <span className="text-xs font-bold uppercase tracking-wider text-slate-400">Question {currentIndex + 1}/{questions.length}</span>
              <div className="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-sm font-bold">Score: {score}</div>
            </div>
            
            <ProgressBar current={currentIndex} total={questions.length} />
            
            <Card>
              {!feedback && (
                <div className="p-8">
                  <h2 className="text-2xl font-bold text-slate-800 mb-8 leading-snug">{q.question}</h2>
                  <div className="grid gap-3 mb-8">
                    {q.options.map((opt, idx) => (
                      <button
                        key={idx}
                        onClick={() => submitAnswer(opt)}
                        className="w-full text-left p-5 rounded-xl border-2 font-medium transition-all duration-200 border-slate-100 hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md text-slate-600 hover:text-indigo-900 bg-slate-50/50"
                      >
                        {opt}
                      </button>
                    ))}
                  </div>
                  <div className="flex justify-start">
                    <Button onClick={prevQuestion} variant="ghost" disabled={currentIndex === 0} className="text-sm px-0 hover:bg-transparent text-slate-400 hover:text-slate-600">
                       <ArrowLeft className="w-4 h-4" /> Previous Question
                    </Button>
                  </div>
                </div>
              )}
              
              {feedback && (
                <FeedbackOverlay 
                  type={feedback.type} 
                  msg={feedback.msg} 
                  examples={feedback.examples}
                  onNext={nextQuestion}
                  onPrev={prevQuestion}
                  isFirst={currentIndex === 0}
                />
              )}
            </Card>
          </div>
        );
      };

      const ResultView = ({ score, playerName, onPlayAgain, onHome }) => (
        <div className="text-center py-12 px-6">
          <div className="inline-block p-6 bg-amber-50 rounded-full mb-8 animate-bounce shadow-lg shadow-amber-100">
            <Trophy className="w-16 h-16 text-amber-500" />
          </div>
          <h2 className="text-4xl font-black text-slate-900 mb-2">Quiz Complete!</h2>
          <p className="text-slate-500 mb-8 font-medium">Great job, {playerName}!</p>
          
          <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 max-w-sm mx-auto mb-10">
            <div className="text-6xl font-black text-indigo-600 mb-2 tracking-tighter">
              {score}
            </div>
            <span className="text-sm font-bold text-slate-400 uppercase tracking-widest">Final Score</span>
          </div>

          <div className="flex justify-center gap-4">
            <Button onClick={onPlayAgain} className="shadow-lg"><RotateCcw className="w-5 h-5" /> Play Again</Button>
            <Button variant="secondary" onClick={onHome}>Home Menu</Button>
          </div>
        </div>
      );

      const LeaderboardView = ({ leaderboard, playerName, onBack }) => (
        <div className="max-w-md mx-auto w-full">
          <div className="flex items-center justify-between mb-8">
            <h2 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
              <Trophy className="w-6 h-6 text-amber-500" /> Leaderboard
            </h2>
          </div>
          <Card className="divide-y divide-slate-100">
            {leaderboard.length === 0 ? (
              <div className="p-8 text-center text-slate-500">No scores yet.</div>
            ) : (
              leaderboard.map((entry, idx) => (
                <div key={idx} className="flex items-center justify-between p-4 hover:bg-slate-50 transition-colors">
                  <div className="flex items-center gap-4">
                    <span className={`w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm ${idx < 3 ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-500'}`}>{idx + 1}</span>
                    <span className={`font-semibold ${entry.name === playerName ? 'text-indigo-600' : 'text-slate-700'}`}>
                      {entry.name} {entry.name === playerName && '(You)'}
                    </span>
                  </div>
                  <span className="font-bold text-slate-900 font-mono">{entry.score}</span>
                </div>
              ))
            )}
          </Card>
          <div className="mt-6 text-center"><Button variant="outline" onClick={onBack}>Back</Button></div>
        </div>
      );

      const StatsView = ({ globalStats, onBack }) => (
        <div className="max-w-2xl mx-auto w-full">
          <div className="flex items-center justify-between mb-8">
            <h2 className="text-3xl font-black text-slate-900 flex items-center gap-3">
              <BarChart3 className="w-8 h-8 text-rose-500" /> Global Hardest Words
            </h2>
          </div>
          
          <Card className="divide-y divide-slate-100">
            {globalStats.length === 0 ? (
              <div className="p-12 text-center text-slate-400">No data collected yet. Be the first to play!</div>
            ) : (
              globalStats.slice(0, 5).map((stat, idx) => (
                <div key={idx} className="p-6 flex items-center justify-between hover:bg-slate-50 transition-colors">
                  <div>
                    <div className="flex items-center gap-3 mb-1">
                      <span className="w-6 h-6 flex items-center justify-center bg-rose-100 text-rose-600 font-bold rounded text-xs">{idx + 1}</span>
                      <h3 className="font-bold text-lg text-slate-800">{stat.term}</h3>
                    </div>
                    <div className="text-xs text-slate-500 font-medium ml-9">
                      Failed {stat.incorrect} times out of {stat.attempts} attempts
                    </div>
                  </div>
                  <div className="text-right">
                    <div className="text-2xl font-black text-rose-500">{Math.round(stat.failRate * 100)}%</div>
                    <div className="text-xs font-bold text-rose-300 uppercase tracking-wider">Fail Rate</div>
                  </div>
                </div>
              ))
            )}
          </Card>
          <div className="mt-8 text-center">
            <p className="text-sm text-slate-500 mb-4">These are the words causing the most trouble for players worldwide.</p>
            <Button onClick={onBack} variant="outline">Back Home</Button>
          </div>
        </div>
      );

      const LearnView = ({ gameData, onClose }) => (
        <div className="max-w-2xl mx-auto w-full">
          <div className="flex items-center justify-between mb-8">
            <h2 className="text-2xl font-bold text-slate-900">Cheat Sheet</h2>
          </div>
          <div className="grid gap-4 pb-12">
            {gameData.map(item => (
              <Card key={item.id} className="p-6 border-l-4 border-l-indigo-500">
                <div className="mb-2">
                  <h3 className="text-lg font-bold text-slate-900">{item.term}</h3>
                  <span className="text-xs font-bold uppercase tracking-wider text-indigo-500 bg-indigo-50 px-2 py-1 rounded-md ml-auto inline-block mt-1">{item.type}</span>
                </div>
                <p className="text-slate-600 mb-4">{item.definition}</p>
                <div className="bg-slate-50 p-3 rounded-lg text-sm text-slate-700 italic border border-slate-100">
                  "{item.examples[0]}"
                </div>
              </Card>
            ))}
          </div>
          <div className="fixed bottom-6 right-6">
             <Button onClick={onClose} className="shadow-xl rounded-full px-6">Close</Button>
          </div>
        </div>
      );

      /**
       * ------------------------------------------------------------------
       * APP COMPONENT
       * ------------------------------------------------------------------
       */

      function App() {
        const [view, setView] = useState('start');
        const [gameData, setGameData] = useState(STATIC_DATA);
        const [isFetching, setIsFetching] = useState(false);
        const [playerName, setPlayerName] = useState(() => localStorage.getItem('pv_player_name') || '');
        
        const user = useAuth();
        const { leaderboard, globalStats, saveScore } = useDataServices(user);
        
        // Save Name Persistence
        useEffect(() => {
          localStorage.setItem('pv_player_name', playerName);
        }, [playerName]);

        // Load Content
        useEffect(() => {
          const fetchDailyContent = async () => {
            if (!window.backendUrl) return; 
            try {
              setIsFetching(true);
              const res = await fetch(window.backendUrl);
              if (res.ok) {
                const dailyData = await res.json();
                if (Array.isArray(dailyData) && dailyData.length > 0) setGameData(dailyData);
              }
            } catch (e) {
              console.warn("Using static fallback data:", e);
            } finally {
              setIsFetching(false);
            }
          };
          fetchDailyContent();
        }, []);

        const regenerateQuestions = async () => {
          if (!window.backendUrl) { alert("Backend URL not configured"); return; }
          try {
            setIsFetching(true);
            const res = await fetch(window.backendUrl, { method: 'POST' });
            if (res.ok) {
              const newData = await res.json();
              if (Array.isArray(newData) && newData.length > 0) {
                setGameData(newData);
                alert("New questions generated!");
              }
            }
          } catch (e) { alert("Generation failed."); } finally { setIsFetching(false); }
        };

        const { 
          questions, currentIndex, score, feedback, isPlaying, 
          startGame: engineStart, submitAnswer, nextQuestion, prevQuestion
        } = useGameEngine((finalScore) => {
          saveScore(finalScore, playerName);
          setView('result');
        }, gameData);

        const handleStartGame = () => {
          if(!playerName.trim()) {
            alert("Please enter a name first!");
            return;
          }
          engineStart();
          setView('game');
        };

        const goHome = () => setView('start');

        // --- MAIN RENDER SWITCH ---
        return (
          <Layout onHome={goHome}>
            {view === 'start' && (
              <StartView 
                playerName={playerName} 
                setPlayerName={setPlayerName}
                onStart={handleStartGame}
                onSetView={setView}
                isFetching={isFetching}
                gameData={gameData}
                onRegenerate={regenerateQuestions}
              />
            )}
            {view === 'game' && (
              <GameView 
                questions={questions}
                currentIndex={currentIndex}
                score={score}
                feedback={feedback}
                submitAnswer={submitAnswer}
                prevQuestion={prevQuestion}
                nextQuestion={nextQuestion}
              />
            )}
            {view === 'result' && (
              <ResultView 
                score={score}
                playerName={playerName}
                onPlayAgain={handleStartGame}
                onHome={goHome}
              />
            )}
            {view === 'leaderboard' && (
              <LeaderboardView 
                leaderboard={leaderboard}
                playerName={playerName}
                onBack={goHome}
              />
            )}
            {view === 'learn' && (
              <LearnView 
                gameData={gameData}
                onClose={goHome}
              />
            )}
            {view === 'stats' && (
              <StatsView 
                globalStats={globalStats}
                onBack={goHome}
              />
            )}
          </Layout>
        );
      }

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
